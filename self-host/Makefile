# Makefile for KBNet Setup

# Variables
DOCKER_COMPOSE = docker-compose.yml
PRISMA_DIR = ./prisma
SEED_DIR = ./seed
API_URL = http://localhost:8000/

.PHONY: help run check-docker check-node check-files check-api check-db check-mindsdb prisma-push seed done

help:
	@echo "Usage:"
	@echo "  make help             Show available commands"
	@echo "  make run              Run the full setup and validation process"

run: check-files check-docker check-node start-docker check-api check-db prisma-push check-mindsdb seed check-api-final done

check-files:
	@echo "âœ… Checking required files..."
	@if [ ! -f $(DOCKER_COMPOSE) ]; then echo "âŒ Missing docker-compose.yml"; exit 1; fi
	@if [ ! -d $(PRISMA_DIR) ]; then echo "âŒ Missing prisma directory"; exit 1; fi
	@if [ ! -d $(SEED_DIR) ]; then echo "âŒ Missing seed directory"; exit 1; fi
	@echo "âœ… All required files are present."

check-docker:
	@echo "ğŸ” Checking Docker installation..."
	@which docker > /dev/null || (echo "âŒ Docker is not installed or not in PATH"; exit 1)
	@docker info > /dev/null || (echo "âŒ Cannot access Docker daemon. Is it running?"; exit 1)
	@echo "âœ… Docker is installed and running."

check-node:
	@echo "ğŸ” Checking Node.js and npm installation..."
	@which node > /dev/null || (echo "âŒ Node.js is not installed or not in PATH"; exit 1)
	@which npm > /dev/null || (echo "âŒ npm is not installed or not in PATH"; exit 1)
	@echo "âœ… Node.js and npm are available."

start-docker:
	@echo "ğŸš€ Starting Docker services..."
	docker-compose -f $(DOCKER_COMPOSE) up -d
	@echo "âŒ› Waiting for API to become available..."
	@sleep 5

check-api:
	@echo "ğŸ” Checking API status..."
	@curl -s --fail $(API_URL) | jq '.' || (echo "âŒ API is not responding"; exit 1)

check-db:
	@echo "ğŸ” Checking if database is connected..."
	@if curl -s $(API_URL) | grep -q '"database":"connected"'; then \
		echo "âœ… Database is connected."; \
	else \
		echo "âŒ Database is not connected."; exit 1; \
	fi

prisma-push:
	@echo "ğŸ”„ Running Prisma DB push..."
	export DATABASE_URL=$(grep DATABASE_URL .env | cut -d '=' -f2-)
	@if [ -z "$$DATABASE_URL" ]; then echo "âŒ DATABASE_URL is not set in .env file"; exit 1; fi
	@echo "Using DATABASE_URL: $$DATABASE_URL"
	@echo "Running Prisma DB push..."
	npx prisma db push --skip-generate

check-mindsdb:
	@echo "ğŸ” Checking if MindsDB is connected..."
	@if curl -s $(API_URL) | grep -q '"mindsDB":"connected"'; then \
		echo "âœ… MindsDB is already connected."; \
	else \
		echo "âš™ï¸ MindsDB is not connected. Running seed script..."; \
		node seed/src/index.js; \
	fi

seed:
	@echo "âœ… Seed process completed (if required)."

check-api-final:
	@echo "ğŸ”„ Final API status check..."
	@curl -s --fail $(API_URL) | jq '.' || (echo "âŒ API is not responding"; exit 1)
	@if curl -s $(API_URL) | grep -q '"mindsDB":"connected"'; then \
		echo "âœ… Setup successful. MindsDB is connected."; \
	else \
		echo "âŒ MindsDB connection failed after seeding."; exit 1; \
	fi

done:
	@echo "ğŸ‰ Setup completed successfully! You can now access the application at http://localhost:3000"
